(function(a){a.fn.extend({writepub_editor:function(d){if(!a.browser.msie&&!a.browser.mozilla&&!a.browser.webkit){return}var c={temporay_image_path:null,on_leave_message:"If you leave, your content will be gone."};a.extend(c,d);id=a(this).attr("id");classes=a(this).attr("class");style=a(this).attr("style");a(this).replaceWith('<iframe id="'+id+'"></iframe>');var b=a("#"+id)[0];b.options=c;a(b).attr("class",classes);a(b).attr("style",style);writepub_editor.insert_toolbar(b);writepub_editor.insert_expand_bar(b);writepub_editor.image_dialog_box.setup(b);writepub_editor.link_dialog_box.setup(b);writepub_editor.video_dialog_box.setup(b);setTimeout(function(){var e=a("#"+id);a(e).attr("class",classes);a(e).attr("style",style);a(e).contents()[0].designMode="on";a(e)[0].contentEditable="true";setTimeout(function(){var f=document.createElement("link");f.href="writepub_content_editor.css";f.rel="stylesheet";f.type="text/css";a(e).contents().find("head")[0].appendChild(f);a(e).contents().keydown(function(g){if(g.ctrlKey==true){doSomething=a("#"+id).writepub_editor_tools(String.fromCharCode(g.which).toLowerCase());if(doSomething==true){g.preventDefault()}}})},100)},100);a(window).bind("beforeunload",function(f){html=a.trim(a("#"+id).contents().find("body").html());if(html=="<br>"||html==""){return}var f=f||window.event;f.returnValue=b.options.on_leave_message;return b.options.on_leave_message})},writepub_editor_tools:function(b){if(b=="b"){writepub_editor.insert_bold(this[0])}else{if(b=="i"){writepub_editor.insert_italic(this[0])}else{if(b=="open_link"){writepub_editor.link_dialog_box.open(this[0])}else{if(b=="link"){writepub_editor.insert_link(this[0],arguments[1])}else{if(b=="open_image"){writepub_editor.image_dialog_box.open(this[0])}else{if(b=="image"){writepub_editor.insert_image(this[0],arguments[1],arguments[2])}else{if(b=="open_video"){writepub_editor.video_dialog_box.open(this[0])}else{if(b=="video"){writepub_editor.insert_video(this[0],arguments[1])}else{return false}}}}}}}}return true}})})(jQuery);var writepub_editor={};writepub_editor.input=null;writepub_editor.selection=null;writepub_editor.insert_bold=function(a){$(a).contents()[0].execCommand("bold",false,"")};writepub_editor.insert_italic=function(a){$(a).contents()[0].execCommand("italic",false,"")};writepub_editor.insert_link=function(a,b){if($.trim(b).match(/^(https?|ftp)/i)==null){throw"An URL must start with 'http', 'https' or 'ftp"}$(a).contents()[0].execCommand("CreateLink",false,b);$(a).contents().find('a[href="'+b+'"]').attr("title",b)};writepub_editor.insert_video=function(b,c){if(c.match(/^(https?:\/\/)?(www.)?youtube.com\//)==null){throw"Youtube's URL is invalid."}if((result=c.match(/^(https?:\/\/)?(www.)?youtube.com\/watch\?(.*)v=([^&]+)/))!=null){c="http://www.youtube.com/embed/"+result[4]}video_html='<iframe width="480" height="390" src="'+c+'" frameborder="0" allowfullscreen></iframe>';if($.browser.msie){var d=$(b)[0].contentWindow.document;if(d.selection&&d.selection.createRange){var a=d.selection.createRange();if(a.pasteHTML){a.pasteHTML(video_html)}}}else{$(b).contents()[0].execCommand("InsertHTML",false,video_html)}};writepub_editor.insert_image=function(b,c){if($.browser.msie){var d='<img src="'+c+'">';var e=$(b)[0].contentWindow.document;if(e.selection&&e.selection.createRange){var a=e.selection.createRange();if(a.pasteHTML){a.pasteHTML(d)}}}else{$(b).contents()[0].execCommand("InsertImage",false,c)}};writepub_editor.show_dialog_box_overlay=function(){if($("#writepub_editor_dialog_box_overlay").length==0){$("body").append('<div id="writepub_editor_dialog_box_overlay" class="writepub_editor_editor_overlay"></div>')}};writepub_editor.close_dialog_box=function(){$("#writepub_editor_dialog_box_overlay").hide();$("#writepub_editor_link_dialog_box").hide();$("#writepub_editor_video_dialog_box").hide();$("#writepub_editor_image_dialog_box").hide()};writepub_editor.insert_toolbar=function(a){var b=a.id;$(a).before('<span class="writepub_editor_toolbar"><input type="button" unselectable="on" class="bold_button" onclick="$(\'#'+b+'\').writepub_editor_tools(\'b\');"><input type="button" unselectable="on" class="italic_button" onclick="$(\'#'+b+'\').writepub_editor_tools(\'i\');"><input type="button" unselectable="on" class="link_button" onclick="$(\'#'+b+'\').writepub_editor_tools(\'open_link\');"><input type="button" unselectable="on" class="image_button" onclick="$(\'#'+b+'\').writepub_editor_tools(\'open_image\');"><input type="button" unselectable="on" class="vdo_button" onclick="$(\'#'+b+"').writepub_editor_tools('open_video');\"></span>")};writepub_editor.insert_expand_bar=function(a){var b=a.id;$(a).after('<span id="'+b+'_expand_bar" unselectable="on" class="writepub_editor_expand_bar" style="width:'+$(a).outerWidth()+'px"><span unselectable="on" onmousedown="this.focus();"></span></span>');$(function(){$("#"+b+"_expand_bar").children("span").draggable({axis:"y",iframeFix:true,scroll:true,scrollSpeed:1,start:function(c,d){$("#"+b).css("opacity",0.4);$("#"+b)[0].save_height=$("#"+b).height()},drag:function(d,e){var f=e.position.top;e.position.top=0;var c=$("#"+b).height();var g=$("#"+b)[0].save_height+f;if(g>100){$("#"+b).css("height",g+"px")}},stop:function(c,d){$("#"+b).css("opacity",1);$("#"+b).focus()}});disableSelection($("#"+b+"_expand_bar").children("span")[0]);disableSelection($("#"+b+"_expand_bar")[0])})};function disableSelection(a){if(typeof a.onselectstart!="undefined"){a.onselectstart=function(){return false}}else{if(typeof a.style.MozUserSelect!="undefined"){a.style.MozUserSelect="none"}else{a.onmousedown=function(){return false}}}}writepub_editor.link_dialog_box={};writepub_editor.link_dialog_box.open=function(a){writepub_editor.input=a;writepub_editor.input.focus();writepub_editor.selection=writepub_editor.helper.save_selection(writepub_editor.input);writepub_editor.show_dialog_box_overlay();if($("#writepub_editor_link_dialog_box").length==0){alert("Please define #writepub_editor_link_dialog_box");writepub_editor.close_dialog_box()}$("#writepub_editor_link_dialog_box_url").val("");$("#writepub_editor_dialog_box_overlay").show();$("#writepub_editor_link_dialog_box").show();$("#writepub_editor_link_dialog_box_url").focus()};writepub_editor.link_dialog_box.submit=function(){var a=$("#writepub_editor_link_dialog_box_url").val();writepub_editor.helper.restore_selection(writepub_editor.input,writepub_editor.selection);try{writepub_editor.insert_link(writepub_editor.input,a);writepub_editor.close_dialog_box();$("#writepub_editor_link_dialog_box_error_panel").hide()}catch(b){$("#writepub_editor_link_dialog_box_error_panel").hide();$("#writepub_editor_link_dialog_box_error_panel").html(b);$("#writepub_editor_link_dialog_box_error_panel").fadeIn()}};writepub_editor.link_dialog_box.setup=function(a){if($("#writepub_editor_link_dialog_box").length>0){return}$(a).after('<div id="writepub_editor_link_dialog_box" class="writepub_editor_link_dialog_box" style="position: fixed; width: 400px; z-index: 1001; top: 50%; left: 50%; display: block; margin-top: -75.5px; margin-left: -203px;display:none;"><div style="display:block;"><h1>Link</h1><span class="writepub_editor_dialog_box_row"><p>URL:</p><input type="text" id="writepub_editor_link_dialog_box_url" class="writepub_editor_dialog_textbox_input" placeholder="URL"/><br/></span><span id="writepub_editor_link_dialog_box_error_panel" style="margin-left:30px;" class="writepub_editor_dialog_box_row" style="display:none;"></span><span class="writepub_editor_dialog_box_row"><input type="button" class="blue_button" value="Add" onclick="writepub_editor.link_dialog_box.submit();"/><input type="button" class="gray_button" value="Close" onclick="writepub_editor.close_dialog_box();"/></span></div></div>');$("#writepub_editor_link_dialog_box_url").keyup(function(b){if(b.which==13){writepub_editor.link_dialog_box.submit()}})};writepub_editor.video_dialog_box={};writepub_editor.video_dialog_box.open=function(a){writepub_editor.input=a;writepub_editor.input.focus();writepub_editor.selection=writepub_editor.helper.save_selection(writepub_editor.input);writepub_editor.show_dialog_box_overlay();if($("#writepub_editor_video_dialog_box").length==0){alert("Please define #writepub_editor_video_dialog_box");writepub_editor.close_dialog_box()}$("#writepub_editor_video_dialog_box_url").val("");$("#writepub_editor_dialog_box_overlay").show();$("#writepub_editor_video_dialog_box").show();$("#writepub_editor_video_dialog_box_url").focus()};writepub_editor.video_dialog_box.submit=function(){var a=$("#writepub_editor_video_dialog_box_url").val();writepub_editor.helper.restore_selection(writepub_editor.input,writepub_editor.selection);try{writepub_editor.insert_video(writepub_editor.input,a);writepub_editor.close_dialog_box();$("#writepub_editor_video_dialog_box_error_panel").hide()}catch(b){$("#writepub_editor_video_dialog_box_error_panel").hide();$("#writepub_editor_video_dialog_box_error_panel").html(b);$("#writepub_editor_video_dialog_box_error_panel").fadeIn()}};writepub_editor.video_dialog_box.setup=function(a){if($("#writepub_editor_video_dialog_box").length>0){return}$(a).after('<div id="writepub_editor_video_dialog_box" class="writepub_editor_video_dialog_box" style="position: fixed; width: 400px; z-index: 1001; top: 50%; left: 50%; display: block; margin-top: -75.5px; margin-left: -203px;display:none;"><div style="display:block;"><h1>Youtube</h1><span class="writepub_editor_dialog_box_row"><p>URL:</p><input type="text" id="writepub_editor_video_dialog_box_url" class="writepub_editor_dialog_textbox_input" placeholder="URL Link"/><br/></span><span id="writepub_editor_video_dialog_box_error_panel" style="margin-left:30px;" class="writepub_editor_dialog_box_row" style="display:none;"></span><span class="writepub_editor_dialog_box_row"><input type="button" class="blue_button" value="Add" onclick="writepub_editor.video_dialog_box.submit();"/><input type="button" class="gray_button" value="Close" onclick="writepub_editor.close_dialog_box();"/></span></div></div>');$("#writepub_editor_video_dialog_box_url").keyup(function(b){if(b.which==13){writepub_editor.video_dialog_box.submit()}})};writepub_editor.image_dialog_box={};writepub_editor.image_dialog_box.open=function(a){writepub_editor.input=a;writepub_editor.input.focus();writepub_editor.selection=writepub_editor.helper.save_selection(writepub_editor.input);writepub_editor.show_dialog_box_overlay();if($("#writepub_editor_image_dialog_box").length==0){alert("Please define #writepub_editor_image_dialog_box");writepub_editor.close_dialog_box()}$("#writepub_editor_image_dialog_box_url").val("");$("#writepub_editor_dialog_box_overlay").show();$("#writepub_editor_image_dialog_box").show();$("#writepub_editor_upload_button").focus()};writepub_editor.image_dialog_box.submit=function(){var a=$("#writepub_editor_image_dialog_box_url").val();writepub_editor.helper.restore_selection(writepub_editor.input,writepub_editor.selection);try{var c=$("#writepub_editor_image_container").children("span");for(var b=0;b<c.length;b++){if($(c[b]).hasClass("selected")&&$(c[b]).find("img").length>0){a=$(c[b]).find("img")[0].src;writepub_editor.insert_image(writepub_editor.input,a);$(c[b]).removeClass("selected")}}writepub_editor.close_dialog_box();$("#writepub_editor_image_dialog_box_error_panel").hide()}catch(d){$("#writepub_editor_image_dialog_box_error_panel").hide();$("#writepub_editor_image_dialog_box_error_panel").html(d);$("#writepub_editor_image_dialog_box_error_panel").fadeIn()}};writepub_editor.image_dialog_box.setup=function(a){if($("#writepub_editor_image_dialog_box").length>0){return}$(a).after('<div id="writepub_editor_image_dialog_box" class="writepub_editor_image_dialog_box" style="position: fixed; width: 430px;height:200px; z-index: 1001; top: 50%; left: 50%; display: block; margin-top: -75.5px; margin-left: -223px;display:none;"><div style="display:block;"><span id="writepub_editor_image_super_container" style="width: 430px;height:170px;overflow:hidden;display:block;"><span id="writepub_editor_image_container" style="width: 430px;height:190px;overflow:scroll;display:block;"></span></span><span id="writepub_editor_image_dialog_box_error_panel" style="display:none;"></span><span class="writepub_editor_dialog_box_row"><input id="writepub_editor_insert_image_button" class="green_button" type="button" value="Insert selected images" onclick="writepub_editor.image_dialog_box.submit();" /><input id="writepub_editor_upload_button" class="blue_button" type="button" value="Upload File" /><input type="button" class="gray_button" value="Close" onclick="writepub_editor.close_dialog_box();"/></span></div></div>');$("#writepub_editor_image_container").delegate(".writepub_editor_thumbnail_unit","click",function(){$(this).toggleClass("selected")});$("#writepub_editor_image_container").delegate(".writepub_editor_thumbnail_unit","dblclick",function(){$(this).addClass("selected");writepub_editor.image_dialog_box.submit()});$("#writepub_editor_upload_button").wiky_uploader({action:a.options.temporary_image_path,mouseover_class:"button_hover",mousedown_class:"button_down",debug:false,params:{max_width:400},onSubmit:function(b,c){$("#writepub_editor_image_container").prepend('<span class="writepub_editor_thumbnail_unit" id="writepub_editor_thumbnail_unit_'+b+'"><span class="writepub_editor_thumbnail_unit_img"><span class="writepub_editor_thumbnail_unit_img_progress"></span></span><span class="writepub_editor_thumbnail_unit_text">'+c+"</span></span>")},onProgress:function(b,e,c,d){progress_span=$("#writepub_editor_thumbnail_unit_"+b).find(".writepub_editor_thumbnail_unit_img_progress");progress_span=progress_span[0]},onComplete:function(b,d,c){$("#writepub_editor_thumbnail_unit_"+b).find(".writepub_editor_thumbnail_unit_img_progress").remove();$("#writepub_editor_thumbnail_unit_"+b).children(".writepub_editor_thumbnail_unit_img").html('<img src="'+c.filename+'"/>')},onCancel:function(c,b){$("#writepub_editor_thumbnail_unit_"+fileId).fadeOut(function(){$(this).remove()})}})};writepub_editor.helper={};writepub_editor.helper.save_selection=function(e){var d=$(e)[0].contentWindow;var f=$(e)[0].contentWindow.document;if(d.getSelection){sel=d.getSelection();if(sel.getRangeAt&&sel.rangeCount){var b=[];for(var c=0,a=sel.rangeCount;c<a;++c){b.push(sel.getRangeAt(c))}return b}}else{if(f.selection&&f.selection.createRange){return f.selection.createRange()}}return null};writepub_editor.helper.restore_selection=function(d,e){var c=$(d)[0].contentWindow;var f=$(d)[0].contentWindow.document;if(e){if(c.getSelection){sel=c.getSelection();sel.removeAllRanges();for(var b=0,a=e.length;b<a;++b){sel.addRange(e[b])}}else{if(f.selection&&e.select){e.select()}}}};